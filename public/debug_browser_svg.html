<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SVG调试 - 河北省路径匹配</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>河北省SVG路径匹配调试</h1>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            output.appendChild(div);
            console.log(message);
        }
        
        async function testSvgMatching() {
            try {
                log('开始测试SVG路径匹配...', 'info');
                
                // 加载SVG文件
                const response = await fetch('/maps/china-combined.svg');
                const svgText = await response.text();
                
                log('SVG文件加载成功，长度: ' + svgText.length, 'success');
                
                // 创建DOM解析器
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                
                // 河北省的ID映射逻辑
                const regionId = 'CN-130000';
                const possibleSvgIds = [regionId];
                if (regionId.startsWith('CN-')) {
                    possibleSvgIds.push(regionId.replace('CN-', ''));
                }
                
                log('尝试的SVG IDs: ' + possibleSvgIds.join(', '), 'info');
                
                // 查找匹配的path元素
                let pathElements = null;
                let usedSvgId = '';
                
                for (const svgId of possibleSvgIds) {
                    log('查找: path[data-region-id="' + svgId + '"]', 'info');
                    const elements = svgDoc.querySelectorAll('path[data-region-id="' + svgId + '"]');
                    log('找到 ' + elements.length + ' 个匹配元素', elements.length > 0 ? 'success' : 'warning');
                    
                    if (elements.length > 0) {
                        pathElements = elements;
                        usedSvgId = svgId;
                        log('✓ 使用SVG ID: ' + svgId, 'success');
                        break;
                    }
                }
                
                if (!pathElements || pathElements.length === 0) {
                    log('❌ 没有找到任何匹配的SVG路径', 'error');
                    return;
                }
                
                // 计算边界框
                log('开始计算边界框...', 'info');
                
                // 创建临时SVG来计算bbox
                const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                tempSvg.setAttribute('viewBox', '0 0 1200 900');
                document.body.appendChild(tempSvg);
                
                let totalX = 0, totalY = 0, count = 0;
                
                pathElements.forEach((pathEl, index) => {
                    const d = pathEl.getAttribute('d');
                    if (d) {
                        const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        tempPath.setAttribute('d', d);
                        tempSvg.appendChild(tempPath);
                        
                        try {
                            const bbox = tempPath.getBBox();
                            const centerX = bbox.x + bbox.width / 2;
                            const centerY = bbox.y + bbox.height / 2;
                            
                            log(`路径 ${index + 1}:`, 'info');
                            log(`  bbox: (${bbox.x.toFixed(2)}, ${bbox.y.toFixed(2)}, ${bbox.width.toFixed(2)}, ${bbox.height.toFixed(2)})`, 'info');
                            log(`  center: (${centerX.toFixed(2)}, ${centerY.toFixed(2)})`, 'info');
                            log(`  percentage: (${(centerX / 1200 * 100).toFixed(2)}%, ${(centerY / 900 * 100).toFixed(2)}%)`, 'success');
                            
                            totalX += centerX;
                            totalY += centerY;
                            count++;
                        } catch (e) {
                            log(`⚠ 获取bbox失败: ${e.message}`, 'warning');
                        }
                        
                        tempSvg.removeChild(tempPath);
                    }
                });
                
                document.body.removeChild(tempSvg);
                
                if (count > 0) {
                    const finalX = (totalX / count / 1200) * 100;
                    const finalY = (totalY / count / 900) * 100;
                    
                    log('=== 最终结果 ===', 'success');
                    log(`河北省SVG中心点: ${finalX.toFixed(2)}%, ${finalY.toFixed(2)}%`, 'success');
                    log(`这个点应该在河北省陆地区域内`, 'success');
                    
                    // 对比经纬度fallback
                    const lat = 38.0428;
                    const lng = 114.5149;
                    const fallbackX = ((lng - 73) / (135 - 73)) * 100;
                    const fallbackY = ((54 - lat) / (54 - 18)) * 100;
                    const finalFallbackX = fallbackX * 0.998 + 0.0;
                    const finalFallbackY = fallbackY * 0.683 + 0.0;
                    
                    log('=== 对比fallback坐标 ===', 'info');
                    log(`经纬度fallback: ${finalFallbackX.toFixed(2)}%, ${finalFallbackY.toFixed(2)}%`, 'warning');
                    log(`差异: X=${(finalX - finalFallbackX).toFixed(2)}%, Y=${(finalY - finalFallbackY).toFixed(2)}%`, 'info');
                }
                
            } catch (error) {
                log('错误: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // 页面加载完成后运行测试
        window.addEventListener('load', testSvgMatching);
    </script>
</body>
</html>