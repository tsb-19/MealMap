<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ä¿®å¤å·¥å…· - è¹­é¥­åœ°å›¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">ğŸ› ï¸ æ•°æ®ä¿®å¤å·¥å…·</h1>
        
        <!-- æ•°æ®æ£€æŸ¥ç»“æœ -->
        <div id="dataCheck" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</h2>
            <div id="checkResults" class="space-y-4">
                <div class="text-gray-600">æ­£åœ¨æ£€æŸ¥æ•°æ®...</div>
            </div>
        </div>

        <!-- ä¿®å¤æ“ä½œ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”§ æ•°æ®ä¿®å¤æ“ä½œ</h2>
            <div class="space-y-4">
                <button id="fixDuplicates" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors">
                    ä¿®å¤é‡å¤åŸå¸‚åç§°
                </button>
                <button id="clearAllData" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors">
                    æ¸…ç©ºæ‰€æœ‰æ•°æ®
                </button>
                <button id="exportData" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
                    å¯¼å‡ºæ•°æ®å¤‡ä»½
                </button>
            </div>
        </div>

        <!-- å½“å‰æ•°æ® -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ å½“å‰æ•°æ®</h2>
            <div id="currentData" class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto">
                <div class="text-gray-600">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // åŠ è½½å¹¶æ£€æŸ¥æ•°æ®
        async function loadAndCheckData() {
            try {
                const response = await fetch('/data/students.json');
                const data = await response.json();
                
                displayCheckResults(data);
                displayCurrentData(data);
                
                return data;
            } catch (error) {
                document.getElementById('checkResults').innerHTML = `
                    <div class="text-red-600">âŒ æ— æ³•åŠ è½½æ•°æ®: ${error.message}</div>
                `;
                return null;
            }
        }

        // æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
        function displayCheckResults(data) {
            const results = document.getElementById('checkResults');
            const students = data.students || [];
            
            // æ£€æŸ¥é‡å¤åŸå¸‚
            const cityCounts = {};
            students.forEach(student => {
                if (student.city) {
                    cityCounts[student.city] = (cityCounts[student.city] || 0) + 1;
                }
            });
            
            const duplicates = Object.entries(cityCounts)
                .filter(([city, count]) => count > 1)
                .map(([city, count]) => ({ city, count }));
            
            let html = `
                <div class="space-y-3">
                    <div class="text-green-600">âœ… æ€»å­¦ç”Ÿæ•°: ${students.length}</div>
                    <div class="text-blue-600">ğŸ“ æ¶‰åŠçœä»½æ•°: ${[...new Set(students.map(s => s.region_name))].length}</div>
                    ${duplicates.length > 0 ? 
                        `<div class="text-red-600">âš ï¸ å‘ç° ${duplicates.length} ä¸ªé‡å¤åŸå¸‚:</div>` :
                        '<div class="text-green-600">âœ… æœªå‘ç°é‡å¤åŸå¸‚</div>'
                    }
                </div>
            `;
            
            if (duplicates.length > 0) {
                html += '<div class="mt-4 space-y-2">';
                duplicates.forEach(dup => {
                    const studentsWithCity = students.filter(s => s.city === dup.city);
                    const regions = [...new Set(studentsWithCity.map(s => s.region_name))];
                    
                    html += `
                        <div class="bg-red-50 border border-red-200 rounded p-3">
                            <div class="font-semibold text-red-800">åŸå¸‚: ${dup.city} (å‡ºç°${dup.count}æ¬¡)</div>
                            <div class="text-red-600 text-sm">å‡ºç°åœ¨ä¸åŒçœä»½: ${regions.join(', ')}</div>
                            <div class="mt-2 space-y-1">
                                ${studentsWithCity.map(s => 
                                    `<div class="text-xs text-gray-600">â€¢ ${s.name} - ${s.region_name}</div>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            results.innerHTML = html;
        }

        // æ˜¾ç¤ºå½“å‰æ•°æ®
        function displayCurrentData(data) {
            const container = document.getElementById('currentData');
            const students = data.students || [];
            
            if (students.length === 0) {
                container.innerHTML = '<div class="text-gray-600">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const html = students.map(student => `
                <div class="border-b border-gray-200 py-2">
                    <div class="font-semibold">${student.name}</div>
                    <div class="text-sm text-gray-600">${student.city} | ${student.region_name}</div>
                    <div class="text-xs text-gray-500">ID: ${student.id}</div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // ä¿®å¤é‡å¤åŸå¸‚
        async function fixDuplicates() {
            if (!confirm('ç¡®å®šè¦ä¿®å¤é‡å¤åŸå¸‚åç§°å—ï¼Ÿè¿™å°†åˆ é™¤é‡å¤çš„å­¦ç”Ÿè®°å½•ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/data/students.json');
                const data = await response.json();
                
                const students = data.students || [];
                const cityRegionMap = {};
                const uniqueStudents = [];
                
                // æŒ‰åŸå¸‚+çœä»½åˆ†ç»„ï¼Œä¿ç•™æ¯ä¸ªç»„åˆçš„ç¬¬ä¸€æ¡è®°å½•
                students.forEach(student => {
                    const key = `${student.city}_${student.region_name}`;
                    if (!cityRegionMap[key]) {
                        cityRegionMap[key] = true;
                        uniqueStudents.push(student);
                    }
                });
                
                const updatedData = { ...data, students: uniqueStudents };
                
                // ä¿å­˜åˆ°localStorageä½œä¸ºæ¼”ç¤ºï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦åç«¯APIï¼‰
                localStorage.setItem('graduation_map_students', JSON.stringify(updatedData));
                
                alert(`ä¿®å¤å®Œæˆï¼åˆ é™¤äº† ${students.length - uniqueStudents.length} æ¡é‡å¤è®°å½•ã€‚`);
                await loadAndCheckData();
                
            } catch (error) {
                alert('ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            localStorage.removeItem('graduation_map_students');
            alert('æ•°æ®å·²æ¸…ç©ºï¼');
            loadAndCheckData();
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = localStorage.getItem('graduation_map_students');
            if (!data) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¹­é¥­åœ°å›¾æ•°æ®å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('fixDuplicates').addEventListener('click', fixDuplicates);
        document.getElementById('clearAllData').addEventListener('click', clearAllData);
        document.getElementById('exportData').addEventListener('click', exportData);

        // åˆå§‹åŒ–
        loadAndCheckData();
    </script>
</body>
</html>